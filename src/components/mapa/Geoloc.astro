---

---

<button
    id="geoloc"
    class="z-50 bg-white hover:bg-emerald-200 cursor-pointer text-white font-bold w-[30px] h-[30px] aspect-square shadow rounded transition-all"
>
    <p id="geolocIcon"></p>
</button>

<script is:inline>
    document.addEventListener("DOMContentLoaded", function () {
        const boton = document.getElementById("geoloc");
        const botonIcon = document.getElementById("geolocIcon");
        let mapaConectado = false;

        // Si no encuentra el bot贸n, salir
        if (!boton) return;

        // Funci贸n para esperar a que el mapa est茅 disponible (respaldo)
        function esperarMapa(callback, intentos = 0) {
            if (window.miMapa && window.miMapa._container) {
                callback();
                return;
            }

            // Reintentar cada 500ms, m谩ximo 10 intentos (5 segundos)
            if (intentos < 10) {
                setTimeout(() => esperarMapa(callback, intentos + 1), 500);
            }
        }

        // Limpiar eventos previos de geolocalizaci贸n para evitar duplicados
        function limpiarEventosAnteriores(map) {
            map.off("locationfound");
            map.off("locationerror");
        }

        // Funci贸n principal de geolocalizaci贸n
        function activarGeolocalizacion() {
            // Verificar que el mapa existe y el bot贸n no est茅 ya procesando
            if (!window.miMapa || boton.disabled) return;

            const map = window.miMapa;
            limpiarEventosAnteriores(map);

            // Cambiar estado visual del bot贸n (texto, disabled, animaci贸n)
            const textoOriginal = botonIcon.textContent;
            botonIcon.textContent = "锔";
            boton.disabled = true;
            botonIcon.classList.add("animate-spin");

            // Timeout para reintentar con configuraci贸n menos estricta despu茅s de 8 segundos
            const timeoutId = setTimeout(() => {
                botonIcon.textContent = "锔";
                map.locate({
                    setView: true,
                    maxZoom: 16,
                    timeout: 15000,
                    enableHighAccuracy: false, // Menos preciso pero m谩s r谩pido
                    maximumAge: 60000, // Acepta ubicaci贸n de hasta 1 minuto
                });
            }, 8000);

            // Cuando se encuentra la ubicaci贸n exitosamente
            function onLocationFound(e) {
                clearTimeout(timeoutId);

                // Limpiar marcadores anteriores de geolocalizaci贸n
                map.eachLayer(function (layer) {
                    if (layer.options && layer.options.isGeoLocation) {
                        map.removeLayer(layer);
                    }
                });

                L.circle(e.latlng, e.accuracy, {
                    weight: 2,
                    color: "black",
                    fillOpacity: 0,
                    dashArray: "5, 10", // Se actualizar谩 din谩micamente
                }).addTo(map);

                // Crear c铆rculo peque帽o central
                L.circleMarker(e.latlng, { 
                    radius: 5, 
                    weight: 1, 
                    color: "black", 
                    fillOpacity: 1.0, 
                    fillColor: "white" 
                }).addTo(map);

                // Restaurar bot贸n con estado de 茅xito
                botonIcon.textContent = "";
                botonIcon.classList.remove("animate-spin");

                // Volver al estado normal despu茅s de 2 segundos
                setTimeout(() => {
                    botonIcon.textContent = textoOriginal;
                    boton.disabled = false;
                }, 2000);

                limpiarEventosAnteriores(map);
            }

            // Cuando hay error en la geolocalizaci贸n
            function onLocationError(e) {
                clearTimeout(timeoutId);

                // Personalizar mensaje seg煤n el tipo de error
                let mensaje = "No se pudo obtener tu ubicaci贸n. ";

                if (e.message.includes("timeout")) {
                    mensaje += "Aseg煤rate de tener GPS activado y estar en un lugar con buena se帽al.";
                } else if (e.message.includes("denied")) {
                    mensaje += "Debes permitir el acceso a tu ubicaci贸n en el navegador.";
                } else {
                    mensaje += "Verifica tu conexi贸n y permisos de ubicaci贸n.";
                }

                alert(mensaje);

                // Restaurar bot贸n al estado normal
                botonIcon.textContent = textoOriginal;
                botonIcon.classList.remove("animate-spin");
                boton.disabled = false;

                limpiarEventosAnteriores(map);
            }

            // Configurar los event listeners para la geolocalizaci贸n
            map.on("locationfound", onLocationFound);
            map.on("locationerror", onLocationError);

            // Iniciar la geolocalizaci贸n con configuraci贸n inicial (alta precisi贸n)
            map.locate({
                setView: true,
                maxZoom: 16,
                timeout: 10000, // 10 segundos timeout
                enableHighAccuracy: true, // M谩xima precisi贸n inicialmente
                maximumAge: 30000, // Acepta ubicaci贸n de hasta 30 segundos
            });
        }

        // Conectar el bot贸n con el evento de clic
        function conectarBoton() {
            if (mapaConectado) return; // Evitar conexiones duplicadas
            boton.addEventListener("click", activarGeolocalizacion);
            mapaConectado = true;
        }

        // Estrategia de conexi贸n: intentar conectar de m煤ltiples maneras

        // 1. Si el mapa ya est谩 disponible, conectar inmediatamente
        if (window.miMapa) {
            conectarBoton();
        } else {
            let eventoConectado = false;

            // 2. Escuchar el evento personalizado 'mapaListo' (m茅todo preferido)
            window.addEventListener("mapaListo", function (e) {
                if (!eventoConectado) {
                    conectarBoton();
                    eventoConectado = true;
                }
            });

            // 3. Como respaldo, usar polling despu茅s de 1 segundo
            setTimeout(() => {
                if (!mapaConectado && !eventoConectado) {
                    esperarMapa(conectarBoton);
                }
            }, 1000);
        }
    });
</script>
